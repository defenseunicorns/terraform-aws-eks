name: test
on:
  repository_dispatch:
    types: [test-command]

permissions:
  id-token: write
  contents: read

defaults:
  run:
    # We need -e -o pipefail for consistency with GitHub Actions' default behavior
    shell: bash -e -o pipefail {0}

jobs:

  debug:
    runs-on: ubuntu-latest
    steps:
    - uses: hmarr/debug-action@v2
    - name: Dump github.event.client_payload context
      env:
        PAYLOAD_CONTEXT: ${{ toJson(github.event.client_payload) }}
      run: echo "$PAYLOAD_CONTEXT" | jq .

  ack:
    runs-on: ubuntu-latest
    if: github.event.client_payload.github.payload.comment.id != ''
    steps:
      - name: "Add reaction"
        uses: cloudposse/actions/github/create-or-update-comment@0.33.0
        with:
          repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
          comment-id: ${{ github.event.client_payload.github.payload.comment.id }}
          token: ${{ secrets.PAT }}
          reactions: 'hooray'

  e2e-test:
    uses: zack-is-cool/delivery-github-actions-workflows/.github/workflows/e2e-test.yml@main
    secrets:
      token: ${{ secrets.PAT }}
